<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Signals Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#121212" />
    <style>
      body {
        background-color: #121212;
        color: #f1f1f1;
        font-family: sans-serif;
      }
      .card {
        margin-bottom: 1rem;
        border-radius: 0.75rem;
        transition: 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
      }
      .card:hover {
        transform: scale(1.03);
      }
      input,
      select {
        margin: 0.5rem 0;
      }
      .card-text small {
        color: #bbb;
      }
      .price {
        font-weight: bold;
        color: #0f0;
      }
      .progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        height: 3px;
        background-color: #29d;
        width: 0;
        z-index: 1031;
        transition: width 30s linear;
      }
    </style>
  </head>
  <body>
    <div class="progress-bar"></div>
    <div class="container py-4">
      <h2 class="mb-4 text-center">Crypto Signals Dashboard</h2>
      <div class="row mb-3 g-2">
        <div class="col-md-4"><input type="text" id="search" class="form-control" placeholder="Search symbol or signal type..." /></div>
        <div class="col-md-4">
          <select id="filterSignal" class="form-select">
            <option value="">All Signal Types</option>
          </select>
        </div>
        <div class="col-md-4">
          <select id="sortOption" class="form-select">
            <option value="">Sort By</option>
            <option value="datetime">Time</option>
            <option value="entry">Entry Price</option>
          </select>
        </div>
      </div>
      <div id="cards" class="row"></div>
    </div>

    <script>
      const JSON_URL = "https://msadeqian.github.io/jd/sg.json"; // local JSON file
      let signalsData = [];

      // Format datetime
      function formatDate(ms) {
        const d = new Date(ms);
        return d.toLocaleString();
      }

      // Fetch live price from custom API
      async function fetchPrice(symbol) {
        try {
          const res = await fetch(`https://tg-poster.boyfromhell.workers.dev/?action=getSymbolPrice&symbol=${symbol}`);
          const data = await res.json();
          return parseFloat(data.price).toFixed(6);
        } catch (e) {
          return "N/A";
        }
      }

      // Render all cards
      async function renderCards(data) {
        const cardsContainer = document.getElementById("cards");
        cardsContainer.innerHTML = "";
        for (const d of data) {
          const card = document.createElement("div");
          card.className = "col-sm-12 col-md-6 col-lg-4";
          card.innerHTML = `<div class="card bg-dark text-light p-3 mb-3">
<h5>${d.symbol}</h5>
<p class="card-text"><strong>Signal:</strong> ${d.signal}</p>
<p class="card-text"><strong>Time:</strong> <small>${formatDate(d.datetime)}</small></p>
<p class="card-text"><strong>Entry:</strong> ${d.entry}</p>
<p class="card-text"><strong>Stop Loss:</strong> ${d.stop_loss ?? "N/A"}</p>
<p class="card-text"><strong>Take Profit:</strong> ${d.take_profit ?? "N/A"}</p>
<p class="card-text"><strong>Current Price:</strong> <span id="price-${d.symbol}" class="price">Loading...</span></p>
<a href="${d.url}" target="_blank" class="btn btn-primary btn-sm mt-2">View Chart</a>
</div>`;
          cardsContainer.appendChild(card);

          // fetch and update live price
          fetchPrice(d.symbol).then((price) => {
            const el = document.getElementById(`price-${d.symbol}`);
            if (el) el.textContent = price;
          });
        }
      }

      // Auto-update prices every 30 seconds
      function autoUpdatePrices() {
        signalsData.forEach((d) => {
          fetchPrice(d.symbol).then((price) => {
            const el = document.getElementById(`price-${d.symbol}`);
            if (el) el.textContent = price;
          });
        });
        setTimeout(autoUpdatePrices, 30000);
      }

      // Filter & sort
      function filterAndSort() {
        const searchQ = document.getElementById("search").value.toLowerCase();
        const signalFilter = document.getElementById("filterSignal").value;
        const sortBy = document.getElementById("sortOption").value;
        let filtered = signalsData.filter((s) => {
          return (s.symbol.toLowerCase().includes(searchQ) || s.signal.toLowerCase().includes(searchQ)) && (!signalFilter || s.signal === signalFilter);
        });
        if (sortBy) {
          filtered.sort((a, b) => {
            if (sortBy === "datetime") return a.datetime - b.datetime;
            return a[sortBy] - b[sortBy];
          });
        }
        renderCards(filtered);
      }

      // Load JSON data
      async function loadSignals() {
        try {
          const res = await fetch(JSON_URL);
          const json = await res.json();
          signalsData = json.data;

          // populate filter
          const types = [...new Set(signalsData.map((d) => d.signal))];
          const filterSelect = document.getElementById("filterSignal");
          types.forEach((t) => {
            let o = document.createElement("option");
            o.value = t;
            o.text = t;
            filterSelect.add(o);
          });

          renderCards(signalsData);
          autoUpdatePrices();
        } catch (err) {
          console.error("Failed to load JSON:", err);
          document.getElementById("cards").innerHTML = '<p class="text-center">Failed to load data. Check your internet connection.</p>';
        }
      }

      // Progress bar
      const progress = document.querySelector(".progress-bar");
      function startProgress() {
        progress.style.width = "0%";
        progress.clientWidth; // reflow
        progress.style.width = "100%";
      }
      startProgress();
      setInterval(startProgress, 30000);

      document.getElementById("search").addEventListener("input", filterAndSort);
      document.getElementById("filterSignal").addEventListener("change", filterAndSort);
      document.getElementById("sortOption").addEventListener("change", filterAndSort);

      loadSignals();

      // Register Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("sw.js")
          .then(() => console.log("SW registered"))
          .catch(console.error);
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
